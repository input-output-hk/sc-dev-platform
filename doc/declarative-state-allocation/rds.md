Allocate RDS instances using OAM definition
===============

This document covers the capability to declaratively allocate state using AWS RDS (Relational Database Service) instance, this capability uses [CrossPlane](https://crossplane.io/) addon to create cloud resources using straightforward Application definitions from OAM/kubeVela.


Creating a new instance
---------------

To create a new instance we have to add a ***rds-instance*** trait with allocateDatabase property as follows:

```yaml
apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: rds-test-owner
  namespace: default
spec:
  components:
  - name: rds-test-owner
    properties:
      cpu: "1"
      exposeType: ClusterIP
      image: nginx
      memory: 1024Mi
      ports:
      - expose: true
        port: 80
        protocol: TCP
    traits:
    - type: scaler
      properties:
        replicas: 1
    - type: rds-instance
      properties:
        # This trait definition will create a new RDS instance
        allocateDatabase:
          storage: 400
          instanceClass: db.t3.medium
        name: chainsync-qa-mainnet
    type: webservice
```
Verifying resource:

```shell
# Please note that CrossPlane objects are not namespace scoped. This is not a bug!
% kubectl get rdsinstance
NAME                   READY   SYNCED   STATE       ENGINE     VERSION   AGE
chainsync-qa-mainnet   True    True     available   postgres   15.4      11h
# Ready and Synced = True, State is available
# Everything is Okay!
```

Some relevant notes about the new instances:

1. We are using a "Security by default" approach:<br>
    1.1. Databases are not publicly available.<br>
    1.2. In-transit encryption is supported.<br>
    1.3. At-rest encryption is enabled.<br>
    1.4. Passwords are randomly generated by AWS and saved in Kubernetes secrets.<br>
    1.5. Automated backups are enabled.<br>
2. Automatic minor version upgrades is disabled by default.
3. Performance Insights is enabled by default.
4. Multi-AZ is enabled by default.
5. Default region is us-east-1 (North Virginia).

This trait also has support for setting some optional properties:

| Property  |  Description  |
|---|---|
| backupRetentionPeriod | Defines a backup retention period (Number of days)<br>*Disable backups setting this property to 0*|
| preferredBackupWindow | Defines backup window schedule |
| preferredMaintenanceWindow | Defines maintenance window schedule |
| iops | Overrides IOPS settings |
| deletionProtection | Enable deletion protection feature |
| customParameters | Update RDS [parameter group](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.PostgreSQL.CommonDBATasks.Parameters.html)<br>*A list of all available parameters can be found [here](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.PostgreSQL.CommonDBATasks.Parameters.html#Appendix.PostgreSQL.CommonDBATasks.Parameters.parameters-list)* |

**⚠️ IMPORTANT**!

Without ***deletionProtection***, the RDS instance is tied to the parent Application lifecycle so if the Application is deleted (or just recycled through VelaUX, for example), the RDS instance is deleted as well.


Using the instance
---------------

After applying the YAML from the example above, we will have a new RDS instance after some minutes and then, it will be time to use it. The ***rds-instance*** trait also has a Patch feature that will update the deployment to ensure that it has all the necessary environment variables to use the RDS instance.

If we have another Application that needs to use the same RDS instance, we can use as such:

```yaml
apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: rds-test-user
  namespace: default
spec:
  components:
  - name: rds-test-user
    properties:
      cpu: "1"
      exposeType: ClusterIP
      image: nginx
      memory: 1024Mi
      ports:
      - expose: true
        port: 80
        protocol: TCP
    traits:
    - type: scaler
      properties:
        replicas: 1
    - type: rds-instance
      properties:
      # This trait is not allocating, just configuring environment variables
      # To use an existent RDS instance
        name: chainsync-qa-mainnet
      type: webservice
```
