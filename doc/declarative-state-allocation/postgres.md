Allocate Postgres instances using OAM definition
===============

This document covers the capability to declaratively allocate state using AWS RDS (Relational Database Service) instance, this capability uses [CrossPlane](https://crossplane.io/) addon to create cloud resources using straightforward Application definitions from OAM/kubeVela.


Creating a new instance
---------------

To create a new instance we have to add a ***postgres-instance*** trait with allocateDatabase property as follows:

```yaml
apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: rds-test-owner
  namespace: default
spec:
  components:
  - name: rds-test-owner
    properties:
      cpu: "1"
      exposeType: ClusterIP
      image: nginx
      memory: 1024Mi
      ports:
      - expose: true
        port: 80
        protocol: TCP
    traits:
    - type: scaler
      properties:
        replicas: 1
    - type: postgres-instance
      properties:
        # This trait definition will create a new RDS instance
        allocateDatabase:
          storage: 400
          instanceClass: db.t3.medium
        name: chainsync-qa-mainnet
    type: webservice
```

The mandatory parameters are:

- **storage**: The amount of storage allocated to the database (`integer`, in Gigabytes).<br>The minimum recommended amount is 400, that increases our IOPS setting to 12000.

- **instanceClass**: The instance class used for the database (`string`)

A note about instance classes:
---------------

This abstraction supports the following instance classes:

| Environment | Size |
|---|---|
| Dev | [t3.medium](https://instances.vantage.sh/aws/rds/db.t3.medium) |
| Dev | [t3.large](https://instances.vantage.sh/aws/rds/db.t3.large) |
| Prod | [db.m7g.large](https://instances.vantage.sh/aws/rds/db.m7g.large) |
| Prod | [db.m7g.xlarge](https://instances.vantage.sh/aws/rds/db.m7g.xlarge) |
| Prod | [db.m7g.2xlarge](https://instances.vantage.sh/aws/rds/db.m7g.2xlarge) |
| Prod | [db.m7g.4xlarge](https://instances.vantage.sh/aws/rds/db.m7g.4xlarge) |

Usually `db.m7g.2xlarge` has enough resources for any kind of our production workloads.


Some relevant notes about the new instances:
---------------

1. Usually the setup takes up to 30 minutes to complete. 
2. We are using a "Security by default" approach:<br>
    2.1. Databases are not publicly available.<br>
    2.2. In-transit encryption is supported.<br>
    2.3. At-rest encryption is enabled.<br>
    2.4. Passwords are randomly generated by AWS and saved in Kubernetes secrets.<br>
    2.5. Automated backups are supported.<br>
3. Automatic minor version upgrades is disabled by default as this feature can introduce availability issues in Production environments.
4. Performance Insights is enabled by default.
5. Multi-AZ is enabled by default.
6. Default region is us-east-1 (North Virginia).

This trait also has support for setting some optional properties:

| Property  |  Description  | Value |
|---|---|---|
| `backupRetentionPeriod` | Defines a backup retention period (Number of days)<br>| integer |
| `preferredBackupWindow` | Defines backup window schedule | formatted string<br>*Example: "07:20-07:50"*|
| `preferredMaintenanceWindow` | Defines maintenance window schedule | formatted string<br>*Example: "sun:03:13-sun:06:43"* |
| `iops` | Overrides IOPS settings.<br>*This is only useful for some specific workloads that requires more than default IOPS setting (which is 12000, if storage is >= 400 GB)* | integer |
| `customParameters` | Update RDS [parameter group](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.PostgreSQL.CommonDBATasks.Parameters.html)<br>*A list of all available parameters can be found [here](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.PostgreSQL.CommonDBATasks.Parameters.html#Appendix.PostgreSQL.CommonDBATasks.Parameters.parameters-list)* | list(map(string))

**⚠️ IMPORTANT!**

The automated backup feature is enabled by default. If `backupRetentionPeriod` is not set up, we will assume a default value of 1, which means that all instances will keep exactly 1 snapshot updated. If `backupRetentionPeriod` is set to zero (0), no automated backup will be taken.


Using the instance
---------------

After applying the YAML from the example above, we will have a new RDS instance after some minutes and then, it will be time to use it. The ***postgres-instance*** trait also has a Patch feature that will update the deployment to ensure that it has all the necessary environment variables to use the RDS instance.

If we have another Application that needs to use the same RDS instance, we can use as such:

```yaml
apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: rds-test-user
  namespace: default
spec:
  components:
  - name: rds-test-user
    properties:
      cpu: "1"
      exposeType: ClusterIP
      image: nginx
      memory: 1024Mi
      ports:
      - expose: true
        port: 80
        protocol: TCP
    traits:
    - type: scaler
      properties:
        replicas: 1
    - type: postgres-instance
      properties:
      # This trait is not allocating, just configuring environment variables
      # To use an existent RDS instance
        name: chainsync-qa-mainnet
      type: webservice
```
The updated deployment environment variables will look like this:

```yaml
      containers:
      - env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              key: username
              name: conn-chainsync-qa-mainnet
        - name: DB_PASS
          valueFrom:
            secretKeyRef:
              key: password
              name: conn-chainsync-qa-mainnet
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              key: endpoint
              name: conn-chainsync-qa-mainnet
        - name: DB_NAME
          value: scdedb
```

**⚠️ IMPORTANT!**

Due to RBAC restrictions, It only works if the Application is in the same namespace of the Application that allocated the Postgres instance.