apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  labels:
    addons.oam.dev/name: crossplane
    addons.oam.dev/registry: KubeVela
    addons.oam.dev/version: 1.14.0
  name: addon-crossplane
  namespace: vela-system
spec:
  components:
  - name: crossplane
    properties:
      chart: crossplane
      repoType: helm
      url: https://charts.crossplane.io/stable
      values:
        replicas: 2 
        extraObjects:
          - apiVersion: pkg.crossplane.io/v1alpha1
            kind: ControllerConfig
            metadata:
              name: aws-config
              annotations:
                eks.amazonaws.com/role-arn: arn:aws:iam::677160962006:role/CrossPlaneAdministratorAccessRole
                helm.sh/hook: post-install
            spec:
              podSecurityContext:
                fsGroup: 2000
          - apiVersion: pkg.crossplane.io/v1
            kind: Provider
            metadata:
              name: provider-aws
              annotations:
                helm.sh/hook: post-install
            spec:
              package: xpkg.upbound.io/crossplane-contrib/provider-aws:v0.44.2
              controllerConfigRef:
                name: aws-config
      version: 1.14.0
    type: helm
  - name: crossplane-provider-config
    properties:
      objects:
        - apiVersion: aws.crossplane.io/v1beta1
          kind: ProviderConfig
          metadata:
            name: aws-provider
          spec:
            credentials:
              source: InjectedIdentity
    type: k8s-objects
  workflow:
    steps:
      - name: apply-crossplane
        type: apply-component
        properties:
          component: crossplane
      - name: wait-crds
        type: suspend
        properties:
          duration: "3m"
      - name: apply-crossplane-config
        type: apply-component
        properties:
          component: crossplane-provider-config
